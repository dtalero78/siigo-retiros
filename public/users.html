<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - Entrevistas de Retiro</title>
    <link rel="stylesheet" href="/css/fonts.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* === VARIABLES === */
        :root {
            --siigo: #08acfc;
            --siigo-dark: #0694d3;
            --siigo-light: #e6f7ff;
        }
        
        body {
            background-color: #f5f6fa;
            font-family: 'Muli', sans-serif;
        }
        
        .navbar {
            background: linear-gradient(45deg, var(--siigo), var(--siigo-dark));
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: 600;
            font-size: 1.25rem;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        .card-header {
            background: var(--siigo-light);
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
            border-radius: 12px 12px 0 0 !important;
        }
        
        .stats-card {
            text-align: center;
            padding: 25px;
            border-radius: 12px;
            color: white;
            margin-bottom: 20px;
        }
        
        .stats-card.total {
            background: linear-gradient(135deg, #1e81b0 0%, #154c79 100%);
        }
        
        .stats-card.pending {
            background: linear-gradient(135deg, #e28743 0%, #873e23 100%);
        }
        
        .stats-card.areas {
            background: linear-gradient(135deg, #76b5c5 0%, #abdbe3 100%);
        }
        
        .stats-card.countries {
            background: linear-gradient(135deg, #eab676 0%, #e28743 100%);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stats-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .table {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table thead th {
            background-color: var(--siigo);
            color: white;
            border: none;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--siigo), var(--siigo-dark));
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(8, 172, 252, 0.3);
        }
        
        .btn-edit {
            background: linear-gradient(45deg, #ffc107, #ff9800);
            border: none;
            color: white;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }
        
        .btn-edit:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
            color: white;
        }
        
        .btn-delete {
            background: linear-gradient(45deg, #dc3545, #c82333);
            border: none;
            color: white;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }
        
        .btn-whatsapp {
            background: linear-gradient(45deg, #25d366, #128c7e);
            border: none;
            color: white;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }
        
        .btn-whatsapp:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
            color: white;
        }
        
        .btn-whatsapp:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .modal-header {
            background: var(--siigo);
            color: white;
        }
        
        .modal-header .btn-close {
            filter: invert(1);
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .drag-drop-zone {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .drag-drop-zone:hover,
        .drag-drop-zone.dragover {
            border-color: var(--siigo);
            background: var(--siigo-light);
        }
        
        .file-upload-text {
            margin-top: 15px;
            color: #6c757d;
        }
        
        .upload-progress {
            margin-top: 15px;
        }
        
        /* Mobile optimizations */
        /* ...todo tu CSS anterior... */

@media (max-width: 768px) {
    .stats-card {
        padding: 20px;
        margin-bottom: 15px;
    }
    .stats-number {
        font-size: 2rem;
    }
    .table-responsive {
        font-size: 0.875rem;
    }
    .btn-edit, .btn-delete, .btn-whatsapp {
        padding: 4px 8px;
        font-size: 0.8rem;
    }
    .navbar-brand {
        font-size: 1.1rem;
    }
    .d-flex.gap-1 {
        flex-direction: column;
        gap: 2px !important;
    }
    .d-flex.gap-1 .btn {
        width: 100%;
        justify-content: center;
    }
}

    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container">
            <div class="d-flex align-items-center">
                <img src="/images/siigo-logo.png" alt="Siigo Logo" class="me-3" style="height: 40px; width: auto;">
                <span class="navbar-brand mb-0 h1">
                    <i class="bi bi-people me-2"></i>
                    Gestión de Usuarios
                </span>
            </div>
            <div class="d-flex gap-2">
                <a href="/admin" class="btn btn-outline-light">
                    <i class="bi bi-graph-up me-1"></i>
                    Respuestas
                </a>
                <a href="/" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left me-1"></i>
                    Formulario
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Estadísticas -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6">
                <div class="stats-card total">
                    <div class="stats-number" id="totalUsers">-</div>
                    <div class="stats-label">Total Usuarios</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stats-card pending">
                    <div class="stats-number" id="pendingUsers">-</div>
                    <div class="stats-label">Pendientes</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stats-card areas">
                    <div class="stats-number" id="totalAreas">-</div>
                    <div class="stats-label">Áreas</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stats-card countries">
                    <div class="stats-number" id="totalCountries">-</div>
                    <div class="stats-label">Países</div>
                </div>
            </div>
        </div>

        <!-- Acciones principales -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-person-plus me-2"></i>
                            Agregar Usuario Individual
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Agrega un usuario manualmente al sistema.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="bi bi-plus-circle me-2"></i>
                            Agregar Usuario
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-upload me-2"></i>
                            Cargar desde CSV
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Carga múltiples usuarios desde un archivo CSV.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadCsvModal">
                            <i class="bi bi-file-earmark-arrow-up me-2"></i>
                            Cargar CSV
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-whatsapp me-2"></i>
                            Mensaje Personalizado
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Envía mensajes personalizados por WhatsApp a usuarios filtrados.</p>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#whatsappMessageModal">
                            <i class="bi bi-send me-2"></i>
                            Configurar Mensaje
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <!-- === FILTROS === -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-funnel me-2"></i>
                    Filtros
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="filterSelect" class="form-label">Filtrar por estado:</label>
                        <select class="form-control" id="filterSelect" onchange="applyFilter(this.value)">
                            <option value="">Todos los usuarios</option>
                            <option value="whatsapp_sent">WhatsApp enviado</option>
                            <option value="whatsapp_not_sent">WhatsApp no enviado</option>
                            <option value="no_response">Sin respuesta</option>
                            <option value="has_response">Con respuesta</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3 d-flex align-items-end">
                        <button class="btn btn-secondary" onclick="clearFilter()">
                            <i class="bi bi-x-circle me-1"></i>
                            Limpiar Filtro
                        </button>
                    </div>
                    <div class="col-md-4 mb-3 d-flex align-items-end justify-content-end">
                        <div id="filterStats" class="text-muted small"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de usuarios -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-table me-2"></i>
                    Usuarios Registrados
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="exportUsers()">
                        <i class="bi bi-download me-2"></i>
                        Exportar CSV
                    </button>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#whatsappMessageModal">
                        <i class="bi bi-whatsapp me-2"></i>
                        Envío Masivo
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="loadingSpinner" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>

                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="bi bi-person-x"></i>
                    <h4>No hay usuarios registrados</h4>
                    <p>Los usuarios aparecerán aquí una vez que sean agregados al sistema.</p>
                </div>

                <div id="usersTable" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Apellido</th>
                                    <th>Identificación</th>
                                    <th>Celular</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Retiro</th>
                                    <th>Cargo</th>
                                    <th>Área</th>
                                    <th>SubÁrea</th>
                                    <th>Líder</th>
                                    <th>Líder Entrenamiento</th>
                                    <th>WhatsApp</th>
                                    <th>Respuesta</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar usuario -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">
                        <i class="bi bi-person-plus me-2"></i>
                        Agregar Usuario
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId" name="userId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">Nombre *</label>
                                <input type="text" class="form-control" id="firstName" name="firstName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Apellido *</label>
                                <input type="text" class="form-control" id="lastName" name="lastName" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="identification" class="form-label">Identificación *</label>
                                <input type="text" class="form-control" id="identification" name="identification" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Celular</label>
                                <input type="text" class="form-control" id="phone" name="phone">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fechaInicio" class="form-label">Fecha de Inicio</label>
                                <input type="date" class="form-control" id="fechaInicio" name="fechaInicio">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="exitDate" class="form-label">Fecha de Retiro *</label>
                                <input type="date" class="form-control" id="exitDate" name="exitDate" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="cargo" class="form-label">Cargo</label>
                            <input type="text" class="form-control" id="cargo" name="cargo">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="subArea" class="form-label">SubÁrea</label>
                                <input type="text" class="form-control" id="subArea" name="subArea">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lider" class="form-label">Líder</label>
                                <input type="text" class="form-control" id="lider" name="lider">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="liderEntrenamiento" class="form-label">Líder de Entrenamiento</label>
                            <input type="text" class="form-control" id="liderEntrenamiento" name="liderEntrenamiento">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="area" class="form-label">Área *</label>
                                <select class="form-control" id="area" name="area" required>
                                    <option value="">Selecciona un área</option>
                                    <option value="Aliados">Aliados</option>
                                    <option value="Cargo en Entrenamiento">Cargo en Entrenamiento</option>
                                    <option value="Commercial Ops">Commercial Ops</option>
                                    <option value="Compensation & Benefits">Compensation & Benefits</option>
                                    <option value="Cross Selling">Cross Selling</option>
                                    <option value="Cultura">Cultura</option>
                                    <option value="Customer Success">Customer Success</option>
                                    <option value="Data Analytics">Data Analytics</option>
                                    <option value="Digital Strategy Engineering">Digital Strategy Engineering</option>
                                    <option value="Engagement & Retention Core">Engagement & Retention Core</option>
                                    <option value="Engagement & Retention Empresario">Engagement & Retention Empresario</option>
                                    <option value="Entrenamiento y Excelencia">Entrenamiento y Excelencia</option>
                                    <option value="Finance & Administration">Finance & Administration</option>
                                    <option value="Fundación Siigo">Fundación Siigo</option>
                                    <option value="Ingenieria Cloud">Ingenieria Cloud</option>
                                    <option value="Ingenieria Legacy">Ingenieria Legacy</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Marketing Channels">Marketing Channels</option>
                                    <option value="Marketing Valor Agregado / Training">Marketing Valor Agregado / Training</option>
                                    <option value="Onboarding">Onboarding</option>
                                    <option value="People Ops">People Ops</option>
                                    <option value="Product">Product</option>
                                    <option value="Quality Assurance Cloud">Quality Assurance Cloud</option>
                                    <option value="Renovaciones">Renovaciones</option>
                                    <option value="Sales">Sales</option>
                                    <option value="Small and Medium Business">Small and Medium Business</option>
                                    <option value="Soporte Legacy">Soporte Legacy</option>
                                    <option value="Soporte Nube">Soporte Nube</option>
                                    <option value="Strategy">Strategy</option>
                                    <option value="Talent Acquisition">Talent Acquisition</option>
                                    <option value="Tech">Tech</option>
                                    <option value="Transformation & Innovation">Transformation & Innovation</option>
                                </select>
                            </div>
                            <input type="hidden" id="country" name="country" value="">
                            <input type="hidden" id="paisContratacion" name="paisContratacion" value="">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">
                        <i class="bi bi-save me-2"></i>
                        Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para mensaje personalizado de WhatsApp -->
    <div class="modal fade" id="whatsappMessageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-whatsapp me-2"></i>
                        Envío de WhatsApp Personalizado
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="whatsappFilter" class="form-label">Seleccionar destinatarios:</label>
                        <select class="form-control" id="whatsappFilter">
                            <option value="all">Todos los usuarios con teléfono</option>
                            <option value="whatsapp_not_sent">Usuarios sin mensaje previo</option>
                            <option value="whatsapp_sent">Usuarios con mensaje previo (reenvío)</option>
                            <option value="no_response">Usuarios sin respuesta</option>
                            <option value="filtered">Usuarios filtrados actualmente</option>
                        </select>
                        <small class="text-muted">Se mostrarán <span id="recipientCount">0</span> usuarios según el filtro seleccionado</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="whatsappMessage" class="form-label">Mensaje a enviar:</label>
                        <textarea class="form-control" id="whatsappMessage" rows="8" placeholder="Escribe aquí el mensaje que se enviará por WhatsApp...">Hola {nombre},

Esperamos que te encuentres muy bien. Como parte de nuestro proceso de mejora continua, nos gustaría conocer tu experiencia en Siigo.

Por favor, tómate unos minutos para completar nuestra entrevista de retiro: {link}

Tu feedback es muy valioso para nosotros.

Saludos,
Equipo de Recursos Humanos - Siigo</textarea>
                        <small class="text-muted">Usa {nombre} para el primer nombre del usuario y {link} para el enlace personalizado</small>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Vista previa del mensaje:</strong>
                        <div id="messagePreview" class="mt-2" style="white-space: pre-wrap; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            El mensaje aparecerá aquí...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="sendCustomWhatsApp()">
                        <i class="bi bi-send me-2"></i>
                        Enviar Mensajes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cargar CSV -->
    <div class="modal fade" id="uploadCsvModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-upload me-2"></i>
                        Cargar Usuarios desde CSV
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6>Formato del archivo CSV:</h6>
                        <p class="text-muted">El archivo debe tener las siguientes columnas en este orden:</p>
                        <code>Identificación, Nombre, Apellido, País, País de Contratación, Área, SubÁrea, Cargo, Líder, Líder Entrenamiento, Teléfono, Fecha de Inicio, Fecha de Retiro</code>
                        <br><br>
                        <strong>Ejemplo:</strong><br>
                        <code>12345678, Juan, Pérez, Colombia, Colombia, Tech, Cloud, Desarrollador Senior, Carlos López, María García, 3001234567, 2023-01-15, 2024-12-31</code>
                    </div>
                    
                    <div class="drag-drop-zone" onclick="document.getElementById('csvFile').click()">
                        <i class="bi bi-cloud-arrow-up" style="font-size: 3rem; color: var(--siigo);"></i>
                        <div class="file-upload-text">
                            <strong>Haz clic aquí o arrastra tu archivo CSV</strong>
                            <br>
                            <small class="text-muted">Tamaño máximo: 10MB</small>
                        </div>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                    </div>
                    
                    <div id="uploadProgress" class="upload-progress" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="mt-2">
                            <small id="uploadStatus" class="text-muted">Preparando carga...</small>
                        </div>
                    </div>

                    <div id="uploadResults" style="display: none;" class="mt-3">
                        <div class="alert alert-info">
                            <strong>Resultados de la carga:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Usuarios insertados: <span id="insertedCount">0</span></li>
                                <li>Total en archivo: <span id="totalCount">0</span></li>
                                <li>Errores: <span id="errorCount">0</span></li>
                            </ul>
                        </div>
                        <div id="errorDetails" style="display: none;">
                            <h6>Detalles de errores:</h6>
                            <div id="errorList" class="text-danger small"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allUsers = [];
        let currentFilter = null;

        // ===== FUNCIONES PRINCIPALES =====
        
        async function sendWhatsApp(id) {
            console.log('sendWhatsApp called with id:', id);
            const user = allUsers.find(u => u.id === id);
            if (!user || !user.phone) {
                showToast('Este usuario no tiene número de teléfono registrado', 'error');
                return;
            }

            // Confirmar envío
            if (!confirm(`¿Enviar mensaje de WhatsApp a ${user.first_name} ${user.last_name} (${user.phone})?`)) {
                return;
            }

            try {
                const response = await fetch('/api/users/send-whatsapp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: id,
                        phone: user.phone,
                        name: `${user.first_name} ${user.last_name}`
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast('Mensaje de WhatsApp enviado exitosamente', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Error al enviar mensaje de WhatsApp', 'error');
                }
            } catch (error) {
                console.error('Error enviando WhatsApp:', error);
                showToast('Error de conexión al enviar WhatsApp', 'error');
            }
        }

        async function sendMassWhatsApp() {
            console.log('sendMassWhatsApp called');
            const usersWithPhone = allUsers.filter(user => user.phone && user.phone.trim());
            
            if (usersWithPhone.length === 0) {
                showToast('No hay usuarios con número de teléfono registrado', 'error');
                return;
            }

            // Configuración para evitar bloqueos
            const BATCH_SIZE = 20; // Enviar en lotes de 20
            const DELAY_BETWEEN_MESSAGES = 3000; // 3 segundos entre mensajes
            const DELAY_BETWEEN_BATCHES = 30000; // 30 segundos entre lotes
            
            const totalTime = Math.ceil((usersWithPhone.length * DELAY_BETWEEN_MESSAGES + 
                                       Math.floor(usersWithPhone.length / BATCH_SIZE) * DELAY_BETWEEN_BATCHES) / 60000);

            if (!confirm(`¿Enviar mensaje de WhatsApp a ${usersWithPhone.length} usuarios?\n\n⚠️ Para evitar bloqueos, se enviará:\n• En lotes de ${BATCH_SIZE} mensajes\n• Con ${DELAY_BETWEEN_MESSAGES/1000}s entre mensajes\n• Con ${DELAY_BETWEEN_BATCHES/1000}s entre lotes\n\n⏱️ Tiempo estimado: ~${totalTime} minutos`)) {
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            // Mostrar progreso mejorado
            const progressToast = document.createElement('div');
            progressToast.className = 'position-fixed top-0 end-0 p-3';
            progressToast.style.zIndex = '9999';
            progressToast.innerHTML = `
                <div class="toast show bg-info text-white" role="alert">
                    <div class="toast-body">
                        <i class="bi bi-hourglass-split me-2"></i>
                        <div>Enviando mensajes...</div>
                        <div class="small">Progreso: <span id="progress">0/${usersWithPhone.length}</span></div>
                        <div class="small">Lote: <span id="batchProgress">1/${Math.ceil(usersWithPhone.length / BATCH_SIZE)}</span></div>
                        <div class="small">Estado: <span id="statusText">Iniciando...</span></div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressToast);

            // Función para enviar mensajes en lotes
            async function sendInBatches() {
                const batches = [];
                for (let i = 0; i < usersWithPhone.length; i += BATCH_SIZE) {
                    batches.push(usersWithPhone.slice(i, i + BATCH_SIZE));
                }

                for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
                    const batch = batches[batchIndex];
                    const batchNum = batchIndex + 1;
                    
                    // Actualizar progreso de lote
                    const batchProgressElement = document.getElementById('batchProgress');
                    const statusElement = document.getElementById('statusText');
                    
                    if (batchProgressElement) {
                        batchProgressElement.textContent = `${batchNum}/${batches.length}`;
                    }
                    if (statusElement) {
                        statusElement.textContent = `Procesando lote ${batchNum}...`;
                    }

                    // Enviar mensajes del lote actual
                    for (let i = 0; i < batch.length; i++) {
                        const user = batch[i];
                        const overallIndex = batchIndex * BATCH_SIZE + i;
                        
                        try {
                            const response = await fetch('/api/users/send-whatsapp', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    userId: user.id,
                                    phone: user.phone,
                                    name: `${user.first_name} ${user.last_name}`
                                })
                            });

                            if (response.ok) {
                                successCount++;
                            } else {
                                errorCount++;
                                console.warn(`Error enviando a ${user.first_name}: ${response.statusText}`);
                            }
                        } catch (error) {
                            errorCount++;
                            console.error(`Error enviando a ${user.first_name}:`, error);
                        }

                        // Actualizar progreso general
                        const progressElement = document.getElementById('progress');
                        if (progressElement) {
                            progressElement.textContent = `${overallIndex + 1}/${usersWithPhone.length}`;
                        }
                        
                        // Delay entre mensajes (dentro del lote)
                        if (i < batch.length - 1) {
                            if (statusElement) {
                                statusElement.textContent = `Esperando ${DELAY_BETWEEN_MESSAGES/1000}s...`;
                            }
                            await new Promise(resolve => setTimeout(resolve, DELAY_BETWEEN_MESSAGES));
                        }
                    }

                    // Delay más largo entre lotes (excepto después del último lote)
                    if (batchIndex < batches.length - 1) {
                        if (statusElement) {
                            statusElement.textContent = `Pausa entre lotes (${DELAY_BETWEEN_BATCHES/1000}s)...`;
                        }
                        await new Promise(resolve => setTimeout(resolve, DELAY_BETWEEN_BATCHES));
                    }
                }

                // Remover toast de progreso
                progressToast.remove();

                // Mostrar resultado final
                showToast(`Envío completado: ${successCount} exitosos, ${errorCount} errores`, 
                         errorCount > 0 ? 'warning' : 'success');
                         
                // Recargar datos para actualizar el estado
                await loadUsers(currentFilter);
            }

            // Ejecutar envío en lotes
            sendInBatches();
        }

        // ===== FUNCIONES DE CARGA Y RENDERIZADO =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, inicializando...');
            loadUsers();
            
            // Event listeners para el modal de mensaje personalizado
            const messageTextarea = document.getElementById('whatsappMessage');
            const filterSelect = document.getElementById('whatsappFilter');
            
            if (messageTextarea) {
                messageTextarea.addEventListener('input', updateMessagePreview);
                updateMessagePreview(); // Actualizar preview inicial
            }
            
            if (filterSelect) {
                filterSelect.addEventListener('change', updateRecipientCount);
            }
            
            // Actualizar conteo cuando se abre el modal
            const whatsappModal = document.getElementById('whatsappMessageModal');
            if (whatsappModal) {
                whatsappModal.addEventListener('shown.bs.modal', function() {
                    updateRecipientCount();
                    updateMessagePreview();
                });
            }
        });

        async function loadUsers(filter = null) {
            try {
                currentFilter = filter;
                const url = filter ? `/api/users?filter=${encodeURIComponent(filter)}` : '/api/users';
                const response = await fetch(url);
                allUsers = await response.json();
                
                document.getElementById('loadingSpinner').style.display = 'none';
                
                if (allUsers.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    document.getElementById('usersTable').style.display = 'block';
                    renderUsersTable();
                    calculateStats();
                    updateFilterStats();
                }
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                alert('Error cargando los datos. Por favor, recarga la página.');
            }
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            allUsers.forEach(user => {
                const row = document.createElement('tr');
                const exitDate = user.exit_date ? new Date(user.exit_date).toLocaleDateString('es-ES') : '-';
                
                const fechaInicio = user.fechaInicio ? new Date(user.fechaInicio).toLocaleDateString('es-ES') : '-';
                
                const whatsappStatus = user.whatsapp_sent_at ? 
                    `<span class="badge bg-success" title="Enviado: ${new Date(user.whatsapp_sent_at).toLocaleString('es-ES')}">
                        <i class="bi bi-check-circle me-1"></i>Enviado
                    </span>` : 
                    `<span class="badge bg-secondary">
                        <i class="bi bi-x-circle me-1"></i>No enviado
                    </span>`;
                
                const responseStatus = user.has_response ? 
                    `<span class="badge bg-success">
                        <i class="bi bi-chat-fill me-1"></i>Respondió
                    </span>` : 
                    `<span class="badge bg-warning">
                        <i class="bi bi-hourglass me-1"></i>Sin respuesta
                    </span>`;
                
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.first_name}</td>
                    <td>${user.last_name}</td>
                    <td>${user.identification}</td>
                    <td>${user.phone || '-'}</td>
                    <td>${fechaInicio}</td>
                    <td>${exitDate}</td>
                    <td>${user.cargo || '-'}</td>
                    <td><span class="badge bg-primary">${user.area}</span></td>
                    <td>${user.subArea || '-'}</td>
                    <td>${user.lider || '-'}</td>
                    <td>${user.liderEntrenamiento || '-'}</td>
                    <td>${whatsappStatus}</td>
                    <td>${responseStatus}</td>
                    <td>
                        <div class="d-flex gap-1">
                            <button class="btn btn-edit btn-sm" onclick="editUser(${user.id})" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-whatsapp btn-sm" onclick="sendWhatsApp(${user.id})" title="Enviar WhatsApp" ${!user.phone ? 'disabled' : ''}>
                                <i class="bi bi-whatsapp"></i>
                            </button>
                            <button class="btn btn-delete btn-sm" onclick="deleteUser(${user.id})" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function calculateStats() {
            const total = allUsers.length;
            document.getElementById('totalUsers').textContent = total;

            if (total > 0) {
                // Usuarios pendientes (fecha de retiro futura)
                const today = new Date();
                const pending = allUsers.filter(user => {
                    if (!user.exit_date) return false;
                    const exitDate = new Date(user.exit_date);
                    return exitDate > today;
                }).length;
                document.getElementById('pendingUsers').textContent = pending;

                // Áreas únicas
                const areas = [...new Set(allUsers.map(user => user.area))].length;
                document.getElementById('totalAreas').textContent = areas;

                // Países únicos
                const countries = [...new Set(allUsers.map(user => user.country))].length;
                document.getElementById('totalCountries').textContent = countries;
            } else {
                document.getElementById('pendingUsers').textContent = '0';
                document.getElementById('totalAreas').textContent = '0';
                document.getElementById('totalCountries').textContent = '0';
            }
        }

        function resetUserForm() {
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userModalTitle').innerHTML = `
                <i class="bi bi-person-plus me-2"></i>
                Agregar Usuario
            `;
        }

        function editUser(id) {
            const user = allUsers.find(u => u.id === id);
            if (!user) return;

            document.getElementById('userId').value = user.id;
            document.getElementById('firstName').value = user.first_name;
            document.getElementById('lastName').value = user.last_name;
            document.getElementById('identification').value = user.identification;
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('fechaInicio').value = user.fechaInicio || '';
            document.getElementById('exitDate').value = user.exit_date;
            document.getElementById('cargo').value = user.cargo || '';
            document.getElementById('subArea').value = user.subArea || '';
            document.getElementById('lider').value = user.lider || '';
            document.getElementById('liderEntrenamiento').value = user.liderEntrenamiento || '';
            document.getElementById('area').value = user.area;
            document.getElementById('country').value = user.country || '';
            document.getElementById('paisContratacion').value = user.paisContratacion || '';

            document.getElementById('userModalTitle').innerHTML = `
                <i class="bi bi-pencil me-2"></i>
                Editar Usuario
            `;

            const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
            modal.show();
        }

        async function saveUser() {
            const form = document.getElementById('userForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const userId = document.getElementById('userId').value;
            const userData = {
                first_name: document.getElementById('firstName').value.trim(),
                last_name: document.getElementById('lastName').value.trim(),
                identification: document.getElementById('identification').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                fechaInicio: document.getElementById('fechaInicio').value,
                exit_date: document.getElementById('exitDate').value,
                cargo: document.getElementById('cargo').value.trim(),
                subArea: document.getElementById('subArea').value.trim(),
                lider: document.getElementById('lider').value.trim(),
                liderEntrenamiento: document.getElementById('liderEntrenamiento').value.trim(),
                area: document.getElementById('area').value,
                country: document.getElementById('country').value || 'Colombia',
                paisContratacion: document.getElementById('paisContratacion').value || ''
            };

            try {
                let response;
                if (userId) {
                    // Actualizar usuario existente
                    response = await fetch(`/api/users/${userId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userData)
                    });
                } else {
                    // Crear nuevo usuario
                    response = await fetch('/api/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userData)
                    });
                }

                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
                    modal.hide();
                    resetUserForm();
                    await loadUsers(currentFilter);
                    showToast('Usuario guardado exitosamente', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Error al guardar el usuario', 'error');
                }
            } catch (error) {
                console.error('Error guardando usuario:', error);
                showToast('Error de conexión', 'error');
            }
        }

        async function deleteUser(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este usuario?')) {
                return;
            }

            try {
                const response = await fetch(`/api/users/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadUsers(currentFilter);
                    showToast('Usuario eliminado exitosamente', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Error al eliminar el usuario', 'error');
                }
            } catch (error) {
                console.error('Error eliminando usuario:', error);
                showToast('Error de conexión', 'error');
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                showToast('Por favor selecciona un archivo CSV válido', 'error');
                return;
            }

            uploadCsvFile(file);
        }

        async function uploadCsvFile(file) {
            const formData = new FormData();
            formData.append('csvFile', file);

            const progressContainer = document.getElementById('uploadProgress');
            const progressBar = progressContainer.querySelector('.progress-bar');
            const statusText = document.getElementById('uploadStatus');

            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            statusText.textContent = 'Cargando archivo...';

            try {
                const response = await fetch('/api/users/upload-csv', {
                    method: 'POST',
                    body: formData
                });

                progressBar.style.width = '100%';
                statusText.textContent = 'Procesando datos...';

                if (response.ok) {
                    const result = await response.json();
                    showUploadResults(result);
                    await loadUsers(currentFilter);
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Error al procesar el archivo CSV', 'error');
                }
            } catch (error) {
                console.error('Error cargando CSV:', error);
                showToast('Error de conexión', 'error');
            } finally {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
            }
        }

        function showUploadResults(result) {
            document.getElementById('insertedCount').textContent = result.inserted;
            document.getElementById('totalCount').textContent = result.total;
            document.getElementById('errorCount').textContent = result.errors.length;

            const resultsContainer = document.getElementById('uploadResults');
            resultsContainer.style.display = 'block';

            if (result.errors.length > 0) {
                const errorDetails = document.getElementById('errorDetails');
                const errorList = document.getElementById('errorList');
                
                errorList.innerHTML = result.errors.map(err => 
                    `<div>Fila: ${JSON.stringify(err.userData)} - Error: ${err.error}</div>`
                ).join('');
                
                errorDetails.style.display = 'block';
            }
        }

        function exportUsers() {
            if (allUsers.length === 0) {
                showToast('No hay usuarios para exportar', 'error');
                return;
            }

            const headers = [
                'ID', 'Nombre', 'Apellido', 'Identificación', 'Celular',
                'Fecha de Inicio', 'Fecha de Retiro', 'Cargo', 'Área', 'SubÁrea', 'Líder', 'Líder Entrenamiento', 'Fecha de Creación'
            ];

            const csvContent = [
                headers.join(','),
                ...allUsers.map(user => [
                    user.id,
                    `"${user.first_name}"`,
                    `"${user.last_name}"`,
                    `"${user.identification}"`,
                    `"${user.phone || ''}"`,
                    user.fechaInicio || '',
                    user.exit_date || '',
                    `"${user.cargo || ''}"`,
                    `"${user.area}"`,
                    `"${user.subArea || ''}"`,
                    `"${user.lider || ''}"`,
                    `"${user.liderEntrenamiento || ''}"`,
                    user.created_at || ''
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `usuarios_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `position-fixed top-0 end-0 p-3`;
            toast.style.zIndex = '9999';
            
            const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
            
            toast.innerHTML = `
                <div class="toast show ${bgClass} text-white" role="alert">
                    <div class="toast-body">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                        ${message}
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Event listeners
        document.getElementById('addUserModal').addEventListener('hidden.bs.modal', resetUserForm);

        // Drag and drop para CSV
        const dropZone = document.querySelector('.drag-drop-zone');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('csvFile').files = files;
                handleFileSelect({ target: { files } });
            }
        });

        // ===== FUNCIONES DE FILTRADO =====
        async function applyFilter(filter) {
            console.log('Applying filter:', filter);
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('usersTable').style.display = 'none';
            await loadUsers(filter);
            // Mostrar/ocultar botón de envío según el filtro
            showSendToFilteredButton();
        }

        async function clearFilter() {
            console.log('Clearing filter');
            currentFilter = null;
            document.getElementById('filterSelect').value = '';
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('usersTable').style.display = 'none';
            await loadUsers();
            // Ocultar botón de envío cuando no hay filtro
            hideSendToFilteredButton();
        }

        function updateFilterStats() {
            if (currentFilter) {
                // Show filter status if there's an active filter
                console.log(`Filter active: ${currentFilter}, showing ${allUsers.length} users`);
            }
        }

        async function showUsersWithoutResponse() {
            console.log('showUsersWithoutResponse called');
            // Cambiar al filtro de "sin respuesta"
            document.getElementById('filterSelect').value = 'no_response';
            await applyFilter('no_response');
            
            // Mostrar el botón de envío para la lista filtrada
            showSendToFilteredButton();
        }

        function showSendToFilteredButton() {
            const sendBtn = document.getElementById('sendToFilteredBtn');
            if (currentFilter === 'no_response') {
                sendBtn.style.display = 'inline-block';
                sendBtn.innerHTML = '<i class="bi bi-arrow-repeat me-2"></i>Enviar a Sin Respuesta';
            } else if (currentFilter) {
                sendBtn.style.display = 'inline-block';
                sendBtn.innerHTML = '<i class="bi bi-whatsapp me-2"></i>Enviar a Lista Filtrada';
            } else {
                sendBtn.style.display = 'none';
            }
        }

        function hideSendToFilteredButton() {
            document.getElementById('sendToFilteredBtn').style.display = 'none';
        }

        async function sendWhatsAppToFilteredUsers() {
            console.log('sendWhatsAppToFilteredUsers called for filter:', currentFilter);
            
            const usersToSend = allUsers.filter(user => user.phone && user.phone.trim());
            
            if (usersToSend.length === 0) {
                showToast('No hay usuarios en la lista actual con número de teléfono registrado', 'error');
                return;
            }

            const filterName = currentFilter === 'no_response' ? 'sin respuesta' : 
                             currentFilter === 'whatsapp_not_sent' ? 'sin WhatsApp enviado' :
                             'de la lista filtrada';

            // Configuración para evitar bloqueos (misma que sendMassWhatsApp)
            const BATCH_SIZE = 20;
            const DELAY_BETWEEN_MESSAGES = 3000;
            const DELAY_BETWEEN_BATCHES = 30000;
            
            const totalTime = Math.ceil((usersToSend.length * DELAY_BETWEEN_MESSAGES + 
                                       Math.floor(usersToSend.length / BATCH_SIZE) * DELAY_BETWEEN_BATCHES) / 60000);

            if (!confirm(`¿Enviar mensaje de WhatsApp a ${usersToSend.length} usuarios ${filterName}?\n\n⚠️ Para evitar bloqueos, se enviará:\n• En lotes de ${BATCH_SIZE} mensajes\n• Con ${DELAY_BETWEEN_MESSAGES/1000}s entre mensajes\n• Con ${DELAY_BETWEEN_BATCHES/1000}s entre lotes\n\n⏱️ Tiempo estimado: ~${totalTime} minutos`)) {
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            // Mostrar progreso mejorado
            const progressToast = document.createElement('div');
            progressToast.className = 'position-fixed top-0 end-0 p-3';
            progressToast.style.zIndex = '9999';
            progressToast.innerHTML = `
                <div class="toast show bg-info text-white" role="alert">
                    <div class="toast-body">
                        <i class="bi bi-hourglass-split me-2"></i>
                        <div>Enviando a usuarios ${filterName}...</div>
                        <div class="small">Progreso: <span id="progressFiltered">0/${usersToSend.length}</span></div>
                        <div class="small">Lote: <span id="batchProgressFiltered">1/${Math.ceil(usersToSend.length / BATCH_SIZE)}</span></div>
                        <div class="small">Estado: <span id="statusTextFiltered">Iniciando...</span></div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressToast);

            // Función para enviar mensajes en lotes
            async function sendFilteredInBatches() {
                const batches = [];
                for (let i = 0; i < usersToSend.length; i += BATCH_SIZE) {
                    batches.push(usersToSend.slice(i, i + BATCH_SIZE));
                }

                for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
                    const batch = batches[batchIndex];
                    const batchNum = batchIndex + 1;
                    
                    // Actualizar progreso de lote
                    const batchProgressElement = document.getElementById('batchProgressFiltered');
                    const statusElement = document.getElementById('statusTextFiltered');
                    
                    if (batchProgressElement) {
                        batchProgressElement.textContent = `${batchNum}/${batches.length}`;
                    }
                    if (statusElement) {
                        statusElement.textContent = `Procesando lote ${batchNum}...`;
                    }

                    // Enviar mensajes del lote actual
                    for (let i = 0; i < batch.length; i++) {
                        const user = batch[i];
                        const overallIndex = batchIndex * BATCH_SIZE + i;
                        
                        try {
                            const response = await fetch('/api/users/send-whatsapp', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    userId: user.id,
                                    phone: user.phone,
                                    name: `${user.first_name} ${user.last_name}`
                                })
                            });

                            if (response.ok) {
                                successCount++;
                            } else {
                                errorCount++;
                                console.warn(`Error enviando a ${user.first_name}: ${response.statusText}`);
                            }
                        } catch (error) {
                            errorCount++;
                            console.error(`Error enviando a ${user.first_name}:`, error);
                        }

                        // Actualizar progreso general
                        const progressElement = document.getElementById('progressFiltered');
                        if (progressElement) {
                            progressElement.textContent = `${overallIndex + 1}/${usersToSend.length}`;
                        }
                        
                        // Delay entre mensajes (dentro del lote)
                        if (i < batch.length - 1) {
                            if (statusElement) {
                                statusElement.textContent = `Esperando ${DELAY_BETWEEN_MESSAGES/1000}s...`;
                            }
                            await new Promise(resolve => setTimeout(resolve, DELAY_BETWEEN_MESSAGES));
                        }
                    }

                    // Delay más largo entre lotes (excepto después del último lote)
                    if (batchIndex < batches.length - 1) {
                        if (statusElement) {
                            statusElement.textContent = `Pausa entre lotes (${DELAY_BETWEEN_BATCHES/1000}s)...`;
                        }
                        await new Promise(resolve => setTimeout(resolve, DELAY_BETWEEN_BATCHES));
                    }
                }

                // Remover toast de progreso
                progressToast.remove();

                // Mostrar resultado final
                showToast(`Envío ${filterName} completado: ${successCount} exitosos, ${errorCount} errores`, 
                         errorCount > 0 ? 'warning' : 'success');
                
                // Recargar datos para actualizar el estado
                await loadUsers(currentFilter);
            }

            // Ejecutar envío en lotes
            sendFilteredInBatches();
        }

        // Función para segundo envío masivo (recordatorio)
        async function sendSecondReminder() {
            console.log('sendSecondReminder called');
            
            const userCount = document.querySelectorAll('#usersTableBody tr').length;
            const effectiveCount = Math.max(0, userCount - 25); // Restamos los 25 que ya recibieron disculpas
            
            if (!confirm(`📱 SEGUNDO ENVÍO - RECORDATORIO\n\n¿Enviar recordatorio a aproximadamente ${effectiveCount} usuarios?\n(Se excluyen los 25 usuarios que ya recibieron el mensaje de disculpas)\n\nMensaje:\n"Hola [nombre] nuevamente!\nAyúdanos a realizar la encuesta. No toma más de 5 minutos y nos ayudas muchísimo a mejorar."\n\n⏱️ Tiempo estimado: ${Math.ceil(effectiveCount * 5 / 60)} minutos\n\n¿Continuar?`)) {
                return;
            }

            // Mostrar progreso
            const progressToast = document.createElement('div');
            progressToast.className = 'position-fixed top-0 end-0 p-3';
            progressToast.style.zIndex = '9999';
            progressToast.innerHTML = `
                <div class="toast show bg-info text-white" role="alert">
                    <div class="toast-body">
                        <i class="bi bi-arrow-repeat me-2"></i>
                        <div>Enviando segundo recordatorio...</div>
                        <div class="small">Estado: <span id="reminderStatus">Iniciando...</span></div>
                        <div class="small">⚠️ Por favor no cierres esta ventana</div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressToast);

            try {
                const statusElement = document.getElementById('reminderStatus');
                if (statusElement) {
                    statusElement.textContent = 'Enviando recordatorios...';
                }

                const response = await fetch('/api/users/send-second-whatsapp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`✅ Segundo envío completado\n\nEnviados: ${result.sent}\nErrores: ${result.errors}\nTotal procesados: ${result.total}\nExcluidos (ya recibieron disculpas): ${result.excluded || 0}\n\n${result.details || ''}`);
                } else {
                    alert(`❌ Error en segundo envío: ${result.error}`);
                }

            } catch (error) {
                console.error('Error en segundo envío:', error);
                alert('Error al enviar recordatorios: ' + error.message);
            } finally {
                progressToast.remove();
            }
        }

        async function sendApologyWhatsApp() {
            console.log('sendApologyWhatsApp called');
            
            if (!confirm('🚨 ENVIAR DISCULPAS A 25 USUARIOS QUE YA HABÍAN RESPONDIDO\n\n¿Enviar mensaje de disculpas a los 25 usuarios que perdieron sus respuestas por el error técnico?\n\n⚠️ Este mensaje explicará la situación y les pedirá que vuelvan a completar la encuesta.\n\n⏱️ El proceso tomará aproximadamente 10-15 minutos.\n\n¿Continuar?')) {
                return;
            }

            // Mostrar progreso
            const progressToast = document.createElement('div');
            progressToast.className = 'position-fixed top-0 end-0 p-3';
            progressToast.style.zIndex = '9999';
            progressToast.innerHTML = `
                <div class="toast show bg-warning text-dark" role="alert">
                    <div class="toast-body">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <div>Enviando disculpas...</div>
                        <div class="small">Estado: <span id="apologyStatus">Iniciando...</span></div>
                        <div class="small">⚠️ Por favor no cierres esta ventana</div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressToast);

            try {
                const statusElement = document.getElementById('apologyStatus');
                if (statusElement) {
                    statusElement.textContent = 'Enviando mensajes de disculpa...';
                }

                const response = await fetch('/api/users/send-apology-whatsapp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                // Remover toast de progreso
                progressToast.remove();

                if (response.ok) {
                    if (result.sent === 0) {
                        showToast(`⚠️ ${result.message}`, 'warning');
                    } else {
                        const messageType = result.errors > 0 ? 'warning' : 'success';
                        const icon = result.errors > 0 ? '⚠️' : '✅';
                        showToast(`${icon} ${result.message}`, messageType);
                        
                        // Mostrar resumen detallado
                        setTimeout(() => {
                            showToast(`📊 Resumen: ${result.sent} exitosos, ${result.errors} errores, de ${result.total} usuarios con teléfono`, 'info');
                        }, 2000);
                    }
                } else {
                    showToast(`❌ Error: ${result.error || 'Error al enviar disculpas'}`, 'error');
                }

                // Recargar datos
                await loadUsers(currentFilter);

            } catch (error) {
                progressToast.remove();
                console.error('Error enviando disculpas WhatsApp:', error);
                showToast('❌ Error de conexión al enviar disculpas', 'error');
            }
        }

        // ===== FUNCIONES DE MENSAJE PERSONALIZADO =====
        function updateMessagePreview() {
            const message = document.getElementById('whatsappMessage').value;
            const preview = document.getElementById('messagePreview');
            
            // Reemplazar variables con ejemplos
            let previewText = message.replace('{nombre}', 'Juan');
            previewText = previewText.replace('{link}', `${window.location.origin}/?user=64`);
            
            preview.textContent = previewText;
        }

        async function updateRecipientCount() {
            const filter = document.getElementById('whatsappFilter').value;
            const countSpan = document.getElementById('recipientCount');
            
            try {
                let count = 0;
                let filteredUsers = [];
                
                // Para filtros que requieren datos actualizados del servidor
                if (filter === 'no_response' || filter === 'has_response') {
                    const response = await fetch(`/api/users?filter=${filter}`);
                    const serverUsers = await response.json();
                    filteredUsers = serverUsers.filter(u => u.phone);
                } else {
                    // Para filtros simples usar datos locales
                    switch(filter) {
                        case 'all':
                            filteredUsers = allUsers.filter(u => u.phone);
                            break;
                        case 'whatsapp_not_sent':
                            filteredUsers = allUsers.filter(u => u.phone && !u.whatsapp_sent_at);
                            break;
                        case 'whatsapp_sent':
                            filteredUsers = allUsers.filter(u => u.phone && u.whatsapp_sent_at);
                            break;
                        case 'filtered':
                            filteredUsers = allUsers.filter(u => u.phone);
                            break;
                    }
                }
                
                count = filteredUsers.length;
                countSpan.textContent = count;
            } catch (error) {
                console.error('Error actualizando conteo de destinatarios:', error);
                countSpan.textContent = '?';
            }
        }

        async function sendCustomWhatsApp() {
            const filter = document.getElementById('whatsappFilter').value;
            const message = document.getElementById('whatsappMessage').value;
            
            if (!message || message.trim() === '') {
                showToast('Por favor escribe un mensaje', 'error');
                return;
            }
            
            // Filtrar usuarios según la selección
            let usersToSend = [];
            
            // Para filtros que requieren datos actualizados del servidor
            if (filter === 'no_response' || filter === 'has_response') {
                try {
                    const response = await fetch(`/api/users?filter=${filter}`);
                    const serverUsers = await response.json();
                    usersToSend = serverUsers.filter(u => u.phone);
                } catch (error) {
                    console.error('Error obteniendo usuarios del servidor:', error);
                    showToast('Error obteniendo datos actualizados del servidor', 'error');
                    return;
                }
            } else {
                // Para filtros simples usar datos locales
                switch(filter) {
                    case 'all':
                        usersToSend = allUsers.filter(u => u.phone);
                        break;
                    case 'whatsapp_not_sent':
                        usersToSend = allUsers.filter(u => u.phone && !u.whatsapp_sent_at);
                        break;
                    case 'whatsapp_sent':
                        usersToSend = allUsers.filter(u => u.phone && u.whatsapp_sent_at);
                        break;
                    case 'filtered':
                        usersToSend = allUsers.filter(u => u.phone);
                        break;
                }
            }
            
            if (usersToSend.length === 0) {
                showToast('No hay usuarios para enviar con el filtro seleccionado', 'warning');
                return;
            }
            
            // Confirmar envío
            if (!confirm(`¿Deseas enviar el mensaje a ${usersToSend.length} usuario(s)?`)) {
                return;
            }
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('whatsappMessageModal'));
            modal.hide();
            
            // Configuración de envío en lotes
            const BATCH_SIZE = 10;
            const DELAY_BETWEEN_MESSAGES = 3000;
            const DELAY_BETWEEN_BATCHES = 30000;
            
            let successCount = 0;
            let errorCount = 0;
            
            // Mostrar progreso
            const progressToast = document.createElement('div');
            progressToast.style.position = 'fixed';
            progressToast.style.top = '20px';
            progressToast.style.right = '20px';
            progressToast.style.zIndex = '9999';
            progressToast.innerHTML = `
                <div class="toast show" role="alert">
                    <div class="toast-body">
                        <strong>Enviando mensajes de WhatsApp...</strong>
                        <div class="mt-2">
                            <div>Progreso: <span id="progress">0/${usersToSend.length}</span></div>
                            <div>Lote: <span id="batchProgress">0/0</span></div>
                            <div>Estado: <span id="statusText">Iniciando...</span></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressToast);
            
            // Función para enviar mensajes en lotes
            async function sendInBatches() {
                const batches = [];
                for (let i = 0; i < usersToSend.length; i += BATCH_SIZE) {
                    batches.push(usersToSend.slice(i, i + BATCH_SIZE));
                }
                
                for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
                    const batch = batches[batchIndex];
                    const batchNum = batchIndex + 1;
                    
                    // Actualizar progreso
                    document.getElementById('batchProgress').textContent = `${batchNum}/${batches.length}`;
                    document.getElementById('statusText').textContent = `Procesando lote ${batchNum}...`;
                    
                    // Enviar mensajes del lote
                    for (let i = 0; i < batch.length; i++) {
                        const user = batch[i];
                        const overallIndex = batchIndex * BATCH_SIZE + i;
                        
                        try {
                            // Personalizar mensaje
                            let personalizedMessage = message.replace('{nombre}', user.first_name);
                            const formUrl = `${window.location.origin}/`;
                            const userLink = `${formUrl}?user=${user.id}`;
                            personalizedMessage = personalizedMessage.replace('{link}', userLink);
                            
                            const response = await fetch('/api/users/send-custom-whatsapp', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    userId: user.id,
                                    phone: user.phone,
                                    message: personalizedMessage
                                })
                            });
                            
                            if (response.ok) {
                                successCount++;
                            } else {
                                errorCount++;
                                const errorData = await response.json();
                                console.error(`Error enviando mensaje a ${user.first_name} ${user.last_name}:`, errorData);
                            }
                        } catch (error) {
                            errorCount++;
                            console.error('Error enviando mensaje:', error);
                        }
                        
                        // Actualizar progreso
                        document.getElementById('progress').textContent = `${overallIndex + 1}/${usersToSend.length}`;
                        
                        // Delay entre mensajes
                        if (i < batch.length - 1) {
                            document.getElementById('statusText').textContent = `Esperando ${DELAY_BETWEEN_MESSAGES/1000}s...`;
                            await new Promise(resolve => setTimeout(resolve, DELAY_BETWEEN_MESSAGES));
                        }
                    }
                    
                    // Delay entre lotes
                    if (batchIndex < batches.length - 1) {
                        document.getElementById('statusText').textContent = `Pausa entre lotes (${DELAY_BETWEEN_BATCHES/1000}s)...`;
                        await new Promise(resolve => setTimeout(resolve, DELAY_BETWEEN_BATCHES));
                    }
                }
                
                // Remover toast de progreso
                progressToast.remove();
                
                // Mostrar resultado
                showToast(`Envío completado: ${successCount} exitosos, ${errorCount} errores`, 
                         errorCount > 0 ? 'warning' : 'success');
                
                // Recargar datos
                await loadUsers(currentFilter);
            }
            
            // Ejecutar envío
            sendInBatches();
        }

        // Hacer las funciones disponibles globalmente
        window.sendWhatsApp = sendWhatsApp;
        window.sendCustomWhatsApp = sendCustomWhatsApp;
        window.sendMassWhatsApp = sendMassWhatsApp;
        window.sendApologyWhatsApp = sendApologyWhatsApp;
        window.showUsersWithoutResponse = showUsersWithoutResponse;
        window.sendWhatsAppToFilteredUsers = sendWhatsAppToFilteredUsers;
        window.applyFilter = applyFilter;
        window.clearFilter = clearFilter;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.saveUser = saveUser;
        window.exportUsers = exportUsers;
        window.handleFileSelect = handleFileSelect;

        console.log('Todas las funciones están disponibles:', {
            sendWhatsApp: typeof window.sendWhatsApp,
            sendMassWhatsApp: typeof window.sendMassWhatsApp,
            sendWhatsAppToNoResponse: typeof window.sendWhatsAppToNoResponse,
            applyFilter: typeof window.applyFilter,
            clearFilter: typeof window.clearFilter,
            editUser: typeof window.editUser,
            deleteUser: typeof window.deleteUser
        });

        // Actualizar datos cada 30 segundos
        setInterval(() => loadUsers(currentFilter), 30000);
    </script>
</body>
</html>