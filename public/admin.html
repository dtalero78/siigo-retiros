<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Entrevistas de Retiro</title>
    <link rel="stylesheet" href="/css/fonts.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* === VARIABLES === */
        :root {
            --siigo: #08acfc;
            --siigo-dark: #0694d3;
            --siigo-light: #e6f7ff;
        }

        body {
            background-color: #f5f6fa;
            font-family: 'Muli', sans-serif;
        }

        .navbar {
            background: linear-gradient(45deg, var(--siigo), var(--siigo-dark));
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 600;
            font-size: 1.25rem;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }

        .card-header {
            background: var(--siigo-light);
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
            border-radius: 12px 12px 0 0 !important;
        }

        .stats-card {
            text-align: center;
            padding: 25px;
            border-radius: 12px;
            color: white;
            margin-bottom: 20px;
        }

        .stats-card.total {
            background: linear-gradient(135deg, #1e81b0 0%, #154c79 100%);
        }

        .stats-card.rating {
            background: linear-gradient(135deg, #e28743 0%, #873e23 100%);
        }

        .stats-card.recommend {
            background: linear-gradient(135deg, #76b5c5 0%, #abdbe3 100%);
        }

        .stats-card.return {
            background: linear-gradient(135deg, #eab676 0%, #e28743 100%);
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stats-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .table {
            border-radius: 8px;
            overflow: hidden;
        }

        .table thead th {
            background-color: var(--siigo);
            color: white;
            border: none;
            font-weight: 600;
        }

        .btn-view {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            color: white;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .btn-view:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            color: white;
        }

        .btn-export {
            background: linear-gradient(45deg, var(--siigo), var(--siigo-dark));
            border: none;
            color: white;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-export:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(8, 172, 252, 0.3);
            color: white;
        }

        .modal-header {
            background: var(--siigo);
            color: white;
        }

        .modal-header .btn-close {
            filter: invert(1);
        }

        .response-detail {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--siigo);
        }

        .response-detail strong {
            display: block;
            margin-bottom: 8px;
            color: #333;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        #analysisModalBody pre {
            font-family: 'Muli', sans-serif;
            font-size: 0.95rem;
            line-height: 1.5;
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            color: #333;
        }

        #analysisModalBody pre {
            font-family: 'Muli', sans-serif;
            font-size: 0.95rem;
            line-height: 1.5;
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            color: #333;
            white-space: normal;
            /* permite saltos de l√≠nea autom√°ticos */
            overflow: visible;
            /* elimina la barra de desplazamiento */
            word-wrap: break-word;
            /* asegura que palabras largas se corten */
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .stats-card {
                padding: 20px;
                margin-bottom: 15px;
            }

            .stats-number {
                font-size: 2rem;
            }

            .table-responsive {
                font-size: 0.875rem;
            }

            .btn-view {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .navbar-brand {
                font-size: 1.1rem;
            }
        }
    </style>
</head>


<body>
    <nav class="navbar navbar-dark">
        <div class="container">
            <div class="d-flex align-items-center">
                <img src="/images/siigo-logo.png" alt="Siigo Logo" class="me-3" style="height: 40px; width: auto;">
                <span class="navbar-brand mb-0 h1">
                    <i class="bi bi-graph-up me-2"></i>
                    Panel de Administraci√≥n
                </span>
            </div>
            <div class="d-flex gap-2">
                <a href="/users" class="btn btn-outline-light">
                    <i class="bi bi-people me-1"></i>
                    Usuarios
                </a>
                <a href="/" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left me-1"></i>
                    Formulario
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Estad√≠sticas -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6">
                <div class="stats-card total">
                    <div class="stats-number" id="totalResponses">-</div>
                    <div class="stats-label">Total Respuestas</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stats-card rating">
                    <div class="stats-number" id="avgRating">-</div>
                    <div class="stats-label">Calificaci√≥n Promedio</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stats-card recommend">
                    <div class="stats-number" id="recommendPercent">-</div>
                    <div class="stats-label">% Recomiendan</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stats-card return">
                    <div class="stats-number" id="returnPercent">-</div>
                    <div class="stats-label">% Regresar√≠an</div>
                </div>
            </div>
        </div>
        


        <!-- Tabla de respuestas -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-table me-2"></i>
                    Respuestas Recibidas
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-export" onclick="exportData()">
                        <i class="bi bi-download me-2"></i>
                        Exportar CSV
                    </button>
                    <button class="btn btn-warning" onclick="generateGlobalAnalysis()">
                        <i class="bi bi-graph-up-arrow me-2"></i>
                        An√°lisis Global de la Organizaci√≥n
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="loadingSpinner" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>

                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="bi bi-inbox"></i>
                    <h4>No hay respuestas a√∫n</h4>
                    <p>Las respuestas de las entrevistas aparecer√°n aqu√≠ una vez que sean enviadas.</p>
                </div>

                <div id="responsesTable" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>√Årea</th>
                                    <th>Pa√≠s</th>
                                    <th>Fecha Retiro</th>
                                    <th>Calificaci√≥n</th>
                                    <th>Fecha Respuesta</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="responsesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver respuesta completa -->
    <div class="modal fade" id="responseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-eye me-2"></i>
                        Detalle de Respuesta
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="responseModalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allResponses = [];

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', function () {
            loadResponses();
        });

        async function loadResponses() {
            try {
                const response = await fetch('/api/responses');
                allResponses = await response.json();

                document.getElementById('loadingSpinner').style.display = 'none';

                if (allResponses.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    document.getElementById('responsesTable').style.display = 'block';
                    renderResponsesTable();
                    calculateStats();
                }
            } catch (error) {
                console.error('Error cargando respuestas:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                alert('Error cargando los datos. Por favor, recarga la p√°gina.');
            }
        }

        function renderResponsesTable() {
            const tbody = document.getElementById('responsesTableBody');
            tbody.innerHTML = '';

            allResponses.forEach(response => {
                const row = document.createElement('tr');
                const createdDate = new Date(response.created_at).toLocaleDateString('es-ES');
                const exitDate = response.exit_date
                    ? new Date(response.exit_date).toLocaleDateString('es-ES')
                    : '-';

                row.innerHTML = `
      <td>${response.id}</td>
      <td>${response.full_name || '-'}</td>
      <td>${response.area || '-'}</td>
      <td>${response.country || '-'}</td>
      <td>${exitDate}</td>
      <td>
        ${response.experience_rating
                        ? `<span class="badge bg-${response.experience_rating >= 7 ? 'success'
                            : response.experience_rating >= 5 ? 'warning' : 'danger'}">
             ${response.experience_rating}/10
           </span>`
                        : '-'}
      </td>
      <td>${createdDate}</td>
      <td>
        <button class="btn btn-view btn-sm" onclick="viewResponse(${response.id})">
          <i class="bi bi-eye me-1"></i>Ver
        </button>
        <button class="btn btn-danger btn-sm ms-1" onclick="deleteResponse(${response.id})" title="Eliminar">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    `;
                tbody.appendChild(row);
            });
        }



        function calculateStats() {
            const total = allResponses.length;
            document.getElementById('totalResponses').textContent = total;

            if (total > 0) {
                // Calificaci√≥n promedio
                const ratings = allResponses.filter(r => r.experience_rating).map(r => r.experience_rating);
                const avgRating = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : 'N/A';
                document.getElementById('avgRating').textContent = avgRating;

                // Porcentaje que recomienda
                const recommends = allResponses.filter(r => r.would_recommend === 'S√ç').length;
                const recommendPercent = ((recommends / total) * 100).toFixed(0) + '%';
                document.getElementById('recommendPercent').textContent = recommendPercent;

                // Porcentaje que regresar√≠a
                const wouldReturn = allResponses.filter(r => r.would_return === 'S√ç').length;
                const returnPercent = ((wouldReturn / total) * 100).toFixed(0) + '%';
                document.getElementById('returnPercent').textContent = returnPercent;
            }
        }

        async function deleteResponse(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar esta respuesta? Esta acci√≥n no se puede deshacer.')) {
                return;
            }

            try {
                const response = await fetch(`/api/responses/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Eliminar de la lista local
                    allResponses = allResponses.filter(r => r.id !== id);
                    
                    // Re-renderizar la tabla
                    renderResponsesTable();
                    calculateStats();
                    
                    // Mostrar mensaje de √©xito
                    showToast('Respuesta eliminada exitosamente', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Error al eliminar la respuesta', 'error');
                }
            } catch (error) {
                console.error('Error eliminando respuesta:', error);
                showToast('Error de conexi√≥n al eliminar', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' : 
                           type === 'error' ? 'bg-danger' : 
                           type === 'warning' ? 'bg-warning' : 'bg-info';
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remover el elemento despu√©s de que se oculte
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }

        async function viewResponse(id) {
            try {
                // 1. Traer los datos del usuario
                const resUser = await fetch(`/api/responses/${id}`);
                const data = await resUser.json();

                // 2. Inyectar el HTML inicial, con loader en An√°lisis AI
                const modalBody = document.getElementById('responseModalBody');
                modalBody.innerHTML = `
      <div class="response-detail">
        <strong>Informaci√≥n Personal</strong>
        <p><strong>Nombre:</strong> ${data.full_name || '-'}</p>
        <p><strong>Identificaci√≥n:</strong> ${data.identification || '-'}</p>
        <p><strong>Fecha de retiro:</strong> ${data.exit_date ? new Date(data.exit_date).toLocaleDateString('es-ES') : '-'}</p>
      </div>

      <div class="response-detail">
        <strong>Informaci√≥n Laboral</strong>
        <p><strong>Tiempo en Siigo:</strong> ${data.tenure || '-'}</p>
        <p><strong>√Årea:</strong> ${data.area || '-'}</p>
        <p><strong>Pa√≠s:</strong> ${data.country || '-'}</p>
        <p><strong>√öltimo l√≠der:</strong> ${data.last_leader || '-'}</p>
      </div>

      <div class="response-detail">
        <strong>Motivo de Retiro</strong>
        <p><strong>Categor√≠a:</strong> ${data.exit_reason_category || '-'}</p>
        <p><strong>Detalle:</strong> ${data.exit_reason_detail || '-'}</p>
      </div>

      <div class="response-detail">
        <strong>Evaluaci√≥n de Experiencia</strong>
        <p><strong>Calificaci√≥n general:</strong> ${data.experience_rating ? `${data.experience_rating}/10` : '-'}</p>
        <p><strong>Recomendar√≠a Siigo:</strong> ${data.would_recommend || '-'}</p>
        <p><strong>Regresar√≠a a Siigo:</strong> ${data.would_return || '-'}</p>
      </div>

      <div class="response-detail">
        <strong>Feedback Cualitativo</strong>
        <p><strong>Lo que m√°s disfrut√≥:</strong> ${data.what_enjoyed || '-'}</p>
        <p><strong>Qu√© mejorar:</strong> ${data.what_to_improve || '-'}</p>
        <p><strong>Nueva empresa:</strong> ${data.new_company_info || '-'}</p>
      </div>

      ${data.satisfaction_ratings
                        ? `<div class="response-detail">
               <strong>Calificaciones de Satisfacci√≥n</strong>
               ${Object.entries(data.satisfaction_ratings)
                            .map(([k, v]) => `<p><strong>${k}:</strong> ${v}/5</p>`)
                            .join('')}
             </div>`
                        : ''
                    }

      <div class="response-detail">
        <strong>An√°lisis AI</strong>
<div id="analysisSection" style="text-align:left; padding-top:1rem; padding-bottom:1rem;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Analizando...</span>
          </div>
        </div>
      </div>

      <div class="response-detail">
        <strong>Informaci√≥n del Sistema</strong>
        <p><strong>Fecha de respuesta:</strong> ${new Date(data.created_at).toLocaleString('es-ES')}</p>
        <p><strong>ID de respuesta:</strong> ${data.id}</p>
      </div>
    `;

                // 3. Mostrar el modal con TODO menos el an√°lisis
                const modal = new bootstrap.Modal(document.getElementById('responseModal'));
                modal.show();

                // 4. Disparar la llamada al endpoint de AI
                const resAI = await fetch(`/api/analysis/${id}`, { method: 'POST' });
                const ai = await resAI.json();

                // 5. Una vez llegue la respuesta, reemplazar el loader por el texto
                const section = document.getElementById('analysisSection');
                
                if (ai.error) {
                    section.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Error:</strong> ${ai.error}
                            ${ai.details ? `<br><small>${ai.details}</small>` : ''}
                        </div>
                    `;
                } else if (ai.analysis && ai.analysis.trim()) {
                    section.innerHTML = marked.parse(ai.analysis);
                } else {
                    section.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-info-circle me-2"></i>
                            No se pudo generar el an√°lisis o est√° vac√≠o.
                        </div>
                    `;
                }


            } catch (error) {
                console.error('Error cargando respuesta o an√°lisis:', error);
                alert('Error cargando los detalles de la respuesta.');
            }
        }



        function exportData() {
            if (allResponses.length === 0) {
                alert('No hay datos para exportar.');
                return;
            }

            // Crear CSV
            const headers = [
                'ID',
                'Nombre Completo',
                'Identificaci√≥n',
                'Fecha de Retiro',
                'Tiempo en Siigo',
                '√Årea',
                'Pa√≠s',
                '√öltimo L√≠der',
                'Motivo Detallado',
                'Categor√≠a de Motivo',
                'Calificaci√≥n Experiencia',
                'Recomendar√≠a',
                'Regresar√≠a',
                'Lo que m√°s disfrut√≥',
                'Qu√© mejorar',
                'Nueva empresa',
                'Fecha de Respuesta'
            ];

            const csvContent = [
                headers.join(','),
                ...allResponses.map(response => [
                    response.id,
                    `"${(response.full_name || '').replace(/"/g, '""')}"`,
                    `"${(response.identification || '').replace(/"/g, '""')}"`,
                    response.exit_date || '',
                    `"${(response.tenure || '').replace(/"/g, '""')}"`,
                    `"${(response.area || '').replace(/"/g, '""')}"`,
                    `"${(response.country || '').replace(/"/g, '""')}"`,
                    `"${(response.last_leader || '').replace(/"/g, '""')}"`,
                    `"${(response.exit_reason_detail || '').replace(/"/g, '""')}"`,
                    `"${(response.exit_reason_category || '').replace(/"/g, '""')}"`,
                    response.experience_rating || '',
                    response.would_recommend || '',
                    response.would_return || '',
                    `"${(response.what_enjoyed || '').replace(/"/g, '""')}"`,
                    `"${(response.what_to_improve || '').replace(/"/g, '""')}"`,
                    `"${(response.new_company_info || '').replace(/"/g, '""')}"`,
                    response.created_at || ''
                ].join(','))
            ].join('\n');

            // Descargar archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `entrevistas_retiro_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Funci√≥n para calcular estad√≠sticas localmente
        function calculateLocalStats(responses) {
            const stats = {
                total_responses: responses.length,
                average_experience_rating: 0,
                would_recommend_percentage: 0,
                would_return_percentage: 0,
                exit_reasons: {},
                areas_analysis: {},
                countries_analysis: {},
                tenure_analysis: {},
                satisfaction_ratings_avg: {}
            };

            let totalExperienceRating = 0;
            let experienceRatingCount = 0;
            let recommendCount = 0;
            let returnCount = 0;

            responses.forEach(resp => {
                // Rating de experiencia
                if (resp.experience_rating) {
                    totalExperienceRating += parseInt(resp.experience_rating);
                    experienceRatingCount++;
                }

                // Recomendaciones
                if (resp.would_recommend === true || resp.would_recommend === 'S√ç') {
                    recommendCount++;
                }

                // Regreso
                if (resp.would_return === true || resp.would_return === 'S√ç') {
                    returnCount++;
                }

                // Pa√≠ses
                if (resp.country) {
                    stats.countries_analysis[resp.country] = (stats.countries_analysis[resp.country] || 0) + 1;
                }

                // √Åreas
                if (resp.area) {
                    if (!stats.areas_analysis[resp.area]) {
                        stats.areas_analysis[resp.area] = {
                            count: 0,
                            avg_experience: 0,
                            would_recommend_percentage: 0
                        };
                    }
                    stats.areas_analysis[resp.area].count++;
                }

                // Tenure
                if (resp.tenure) {
                    stats.tenure_analysis[resp.tenure] = (stats.tenure_analysis[resp.tenure] || 0) + 1;
                }

                // Satisfaction ratings
                if (resp.satisfaction_ratings) {
                    let ratings = resp.satisfaction_ratings;
                    if (typeof ratings === 'string') {
                        try {
                            ratings = JSON.parse(ratings);
                        } catch (e) {
                            ratings = {};
                        }
                    }
                    Object.entries(ratings).forEach(([category, rating]) => {
                        if (!stats.satisfaction_ratings_avg[category]) {
                            stats.satisfaction_ratings_avg[category] = [];
                        }
                        stats.satisfaction_ratings_avg[category].push(parseFloat(rating) || 0);
                    });
                }
            });

            // Calcular promedios
            stats.average_experience_rating = experienceRatingCount > 0 ? 
                (totalExperienceRating / experienceRatingCount).toFixed(1) : 0;
            stats.would_recommend_percentage = ((recommendCount / responses.length) * 100).toFixed(1);
            stats.would_return_percentage = ((returnCount / responses.length) * 100).toFixed(1);

            // Calcular promedios de satisfaction ratings
            Object.keys(stats.satisfaction_ratings_avg).forEach(category => {
                const values = stats.satisfaction_ratings_avg[category];
                stats.satisfaction_ratings_avg[category] = values.length > 0 ? 
                    (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1) : 0;
            });

            return stats;
        }

        // Funci√≥n para generar an√°lisis global
        async function generateGlobalAnalysis() {
            if (allResponses.length === 0) {
                alert('No hay respuestas disponibles para analizar.');
                return;
            }

            const confirmed = confirm(`¬øGenerar an√°lisis global de la organizaci√≥n?\n\nSe analizar√°n ${allResponses.length} respuestas para crear:\n‚Ä¢ Estad√≠sticas detalladas\n‚Ä¢ 3 estrategias de mejora\n‚Ä¢ Plan de acci√≥n con teor√≠as de RRHH\n‚Ä¢ Gr√°ficos y m√©tricas\n\nPrimero se mostrar√°n las estad√≠sticas y luego el an√°lisis de IA.`);
            
            if (!confirmed) return;

            // Calcular estad√≠sticas localmente primero
            const localStats = calculateLocalStats(allResponses);

            // Mostrar modal con estad√≠sticas inmediatamente
            const progressModal = `
                <div class="modal fade" id="analysisModal" tabindex="-1" style="backdrop-filter: blur(5px);">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">
                                    <i class="bi bi-graph-up-arrow me-2"></i>
                                    An√°lisis Global de la Organizaci√≥n
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="analysisModalBody">
                                <!-- Aqu√≠ se mostrar√°n los gr√°ficos inmediatamente -->
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', progressModal);
            const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
            modal.show();

            // Mostrar gr√°ficos inmediatamente con datos locales
            const mockData = {
                data: {
                    resumen_estadistico: localStats,
                    ai_analysis: null // Se llenar√° despu√©s
                },
                timestamp: new Date().toISOString()
            };
            
            displayGlobalAnalysisWithLoading(mockData);

            // Ahora hacer la petici√≥n para obtener el an√°lisis de OpenAI
            try {
                const response = await fetch('/api/analysis/global', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }

                const analysisData = await response.json();
                
                // Actualizar con el an√°lisis completo de OpenAI
                updateAnalysisSection(analysisData.data.ai_analysis);
                window.currentAnalysis = analysisData;

            } catch (error) {
                console.error('Error generando an√°lisis global:', error);
                updateAnalysisSection(`<div class="alert alert-danger">
                    <h4>Error generando an√°lisis de IA</h4>
                    <p>Hubo un problema al generar el an√°lisis con OpenAI: ${error.message}</p>
                    <button class="btn btn-outline-danger" onclick="generateGlobalAnalysis()">
                        Reintentar
                    </button>
                </div>`);
            }
        }

        function displayGlobalAnalysisWithLoading(data) {
            const stats = data.data.resumen_estadistico;
            
            // Crear gr√°ficos inmediatamente (sin an√°lisis de IA a√∫n)
            const chartsHtml = generateChartsHTML(stats);
            
            const content = `
                ${chartsHtml}
                
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-robot me-2"></i>
                                    An√°lisis de IA con OpenAI GPT-4
                                </h6>
                            </div>
                            <div class="card-body" id="aiAnalysisSection">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary mb-3" role="status">
                                        <span class="visually-hidden">Generando an√°lisis con IA...</span>
                                    </div>
                                    <h5>Generando an√°lisis inteligente...</h5>
                                    <p class="text-muted">OpenAI est√° analizando los datos para generar insights y recomendaciones</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('analysisModalBody').innerHTML = content;
            window.currentAnalysis = data;
        }

        function updateAnalysisSection(aiAnalysis) {
            const analysisSection = document.getElementById('aiAnalysisSection');
            if (analysisSection) {
                if (aiAnalysis) {
                    analysisSection.innerHTML = `
                        <div class="analysis-content">
                            ${marked.parse(aiAnalysis)}
                        </div>
                    `;
                } else {
                    analysisSection.innerHTML = `
                        <div class="alert alert-warning">
                            <h5>An√°lisis no disponible</h5>
                            <p>No se pudo generar el an√°lisis de IA en este momento.</p>
                        </div>
                    `;
                }
            }
        }

        function generateChartsHTML(stats) {
            return `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center bg-primary text-white">
                            <div class="card-body">
                                <h2>${stats.total_responses}</h2>
                                <p>Total Respuestas</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-success text-white">
                            <div class="card-body">
                                <h2>${stats.average_experience_rating}/10</h2>
                                <p>Rating Promedio</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-info text-white">
                            <div class="card-body">
                                <h2>${stats.would_recommend_percentage}%</h2>
                                <p>Recomendar√≠an</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-warning text-dark">
                            <div class="card-body">
                                <h2>${stats.would_return_percentage}%</h2>
                                <p>Regresar√≠an</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">An√°lisis por √Årea</h6>
                            </div>
                            <div class="card-body">
                                ${Object.entries(stats.areas_analysis).map(([area, data]) => `
                                    <div class="mb-3">
                                        <h6>${area} <span class="badge bg-primary">${data.count || 0}</span></h6>
                                        <small class="text-muted">
                                            √Årea con ${data.count || 0} respuestas
                                        </small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Distribuci√≥n por Pa√≠s</h6>
                            </div>
                            <div class="card-body">
                                ${Object.entries(stats.countries_analysis).map(([country, count]) => `
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">${country === 'Colombia' ? 'üá®üá¥' : country === 'M√©xico' ? 'üá≤üáΩ' : country === 'Ecuador' ? 'üá™üá®' : country === 'Uruguay' ? 'üá∫üáæ' : country === 'Per√∫' ? 'üáµüá™' : 'üåç'}</span>
                                            <span>${country}</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-info me-2">${count}</span>
                                            <span class="small text-muted">${((count / stats.total_responses) * 100).toFixed(1)}%</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Niveles de Satisfacci√≥n por Categor√≠a</h6>
                            </div>
                            <div class="card-body">
                                ${Object.entries(stats.satisfaction_ratings_avg).map(([category, rating]) => `
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">${category}</small>
                                            <span class="badge ${parseFloat(rating) >= 4 ? 'bg-success' : parseFloat(rating) >= 3 ? 'bg-warning' : 'bg-danger'}">${rating}/5</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar ${parseFloat(rating) >= 4 ? 'bg-success' : parseFloat(rating) >= 3 ? 'bg-warning' : 'bg-danger'}" 
                                                 style="width: ${(parseFloat(rating) / 5) * 100}%" 
                                                 title="${category}: ${rating}/5">
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Tiempo en la Empresa</h6>
                            </div>
                            <div class="card-body">
                                ${Object.entries(stats.tenure_analysis).sort((a, b) => {
                                    const order = ['Menos de 2 meses', 'Menos de 6 meses', '6 meses a 1 a√±o', '1-2 a√±os', '2-5 a√±os', 'M√°s de 5 a√±os'];
                                    return order.indexOf(a[0]) - order.indexOf(b[0]);
                                }).map(([tenure, count]) => `
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="small">${tenure}</span>
                                            <div>
                                                <span class="badge bg-secondary me-1">${count}</span>
                                                <span class="small text-muted">${((count / stats.total_responses) * 100).toFixed(1)}%</span>
                                            </div>
                                        </div>
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar" 
                                                 style="width: ${(count / stats.total_responses) * 100}%; 
                                                        background: linear-gradient(to right, #28a745, #17a2b8);">
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">üéØ M√©tricas de Retenci√≥n y Recomendaci√≥n</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">¬øRecomendar√≠an Siigo?</h6>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="flex-grow-1">
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-success" style="width: ${stats.would_recommend_percentage}%">
                                                        S√ç (${stats.would_recommend_percentage}%)
                                                    </div>
                                                    <div class="progress-bar bg-danger" style="width: ${100 - parseFloat(stats.would_recommend_percentage)}%">
                                                        NO (${(100 - parseFloat(stats.would_recommend_percentage)).toFixed(1)}%)
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">¬øRegresar√≠an a Siigo?</h6>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="flex-grow-1">
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-info" style="width: ${stats.would_return_percentage}%">
                                                        S√ç (${stats.would_return_percentage}%)
                                                    </div>
                                                    <div class="progress-bar bg-secondary" style="width: ${100 - parseFloat(stats.would_return_percentage)}%">
                                                        NO (${(100 - parseFloat(stats.would_return_percentage)).toFixed(1)}%)
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="alert ${parseFloat(stats.would_recommend_percentage) >= 60 ? 'alert-success' : parseFloat(stats.would_recommend_percentage) >= 40 ? 'alert-warning' : 'alert-danger'}" role="alert">
                                            <strong>An√°lisis de Retenci√≥n:</strong>
                                            ${parseFloat(stats.would_recommend_percentage) >= 60 
                                                ? '‚úÖ Excelente nivel de satisfacci√≥n. Los empleados recomiendan activamente trabajar en Siigo.' 
                                                : parseFloat(stats.would_recommend_percentage) >= 40 
                                                ? '‚ö†Ô∏è Nivel de satisfacci√≥n moderado. Hay oportunidades de mejora significativas.' 
                                                : 'üö® Nivel cr√≠tico de satisfacci√≥n. Se requiere acci√≥n inmediata para mejorar la experiencia del empleado.'
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-12 text-center">
                        <button class="btn btn-success me-2" onclick="downloadAnalysis()" title="Descargar reporte en PDF">
                            <i class="bi bi-download me-2"></i>
                            Descargar An√°lisis (PDF)
                        </button>
                    </div>
                </div>
            `;
        }

        function displayGlobalAnalysis(data) {
            const stats = data.data.resumen_estadistico;
            const analysis = data.data.ai_analysis;

            // Crear gr√°ficos y estad√≠sticas
            const chartsHtml = `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center bg-primary text-white">
                            <div class="card-body">
                                <h2>${stats.total_responses}</h2>
                                <p>Total Respuestas</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-success text-white">
                            <div class="card-body">
                                <h2>${stats.average_experience_rating}/10</h2>
                                <p>Rating Promedio</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-info text-white">
                            <div class="card-body">
                                <h2>${stats.would_recommend_percentage}%</h2>
                                <p>Recomendar√≠an</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-warning text-dark">
                            <div class="card-body">
                                <h2>${stats.would_return_percentage}%</h2>
                                <p>Regresar√≠an</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Razones de Salida</h6>
                            </div>
                            <div class="card-body">
                                ${Object.entries(stats.exit_reasons).map(([reason, count]) => `
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>${reason}</span>
                                        <div>
                                            <span class="badge bg-secondary me-2">${count}</span>
                                            <div class="progress" style="width: 100px; height: 8px;">
                                                <div class="progress-bar" style="width: ${(count / stats.total_responses) * 100}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">An√°lisis por √Årea</h6>
                            </div>
                            <div class="card-body">
                                ${Object.entries(stats.areas_analysis).map(([area, data]) => `
                                    <div class="mb-3">
                                        <h6>${area} <span class="badge bg-primary">${data.count}</span></h6>
                                        <small class="text-muted">
                                            Rating: ${data.avg_experience}/10 | 
                                            Recomiendan: ${data.would_recommend_percentage}%
                                        </small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Niveles de Satisfacci√≥n por Categor√≠a</h6>
                            </div>
                            <div class="card-body">
                                ${Object.entries(stats.satisfaction_ratings_avg).map(([category, rating]) => `
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">${category}</small>
                                            <span class="badge ${parseFloat(rating) >= 4 ? 'bg-success' : parseFloat(rating) >= 3 ? 'bg-warning' : 'bg-danger'}">${rating}/5</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar ${parseFloat(rating) >= 4 ? 'bg-success' : parseFloat(rating) >= 3 ? 'bg-warning' : 'bg-danger'}" 
                                                 style="width: ${(parseFloat(rating) / 5) * 100}%" 
                                                 title="${category}: ${rating}/5">
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Distribuci√≥n por Pa√≠s</h6>
                            </div>
                            <div class="card-body">
                                ${Object.entries(stats.countries_analysis).map(([country, count]) => `
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">${country === 'Colombia' ? 'üá®üá¥' : country === 'M√©xico' ? 'üá≤üáΩ' : country === 'Ecuador' ? 'üá™üá®' : country === 'Uruguay' ? 'üá∫üáæ' : country === 'Per√∫' ? 'üáµüá™' : 'üåç'}</span>
                                            <span>${country}</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-info me-2">${count}</span>
                                            <span class="small text-muted">${((count / stats.total_responses) * 100).toFixed(1)}%</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Tiempo en la Empresa</h6>
                            </div>
                            <div class="card-body">
                                ${Object.entries(stats.tenure_analysis).sort((a, b) => {
                                    const order = ['Menos de 2 meses', 'Menos de 6 meses', '6 meses a 1 a√±o', '1-2 a√±os', '2-5 a√±os', 'M√°s de 5 a√±os'];
                                    return order.indexOf(a[0]) - order.indexOf(b[0]);
                                }).map(([tenure, count]) => `
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="small">${tenure}</span>
                                            <div>
                                                <span class="badge bg-secondary me-1">${count}</span>
                                                <span class="small text-muted">${((count / stats.total_responses) * 100).toFixed(1)}%</span>
                                            </div>
                                        </div>
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar" 
                                                 style="width: ${(count / stats.total_responses) * 100}%; 
                                                        background: linear-gradient(to right, #28a745, #17a2b8);">
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Distribuci√≥n de Ratings de Experiencia</h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <div class="display-4 text-success">${stats.average_experience_rating}/10</div>
                                    <small class="text-muted">Rating Promedio</small>
                                </div>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <div class="h5 text-danger mb-1">üîª</div>
                                            <div class="small">1-4 Puntos</div>
                                            <div class="small text-muted">(Cr√≠tico)</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <div class="h5 text-warning mb-1">‚öñÔ∏è</div>
                                            <div class="small">5-7 Puntos</div>
                                            <div class="small text-muted">(Neutral)</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <div class="h5 text-success mb-1">‚≠ê</div>
                                            <div class="small">8-10 Puntos</div>
                                            <div class="small text-muted">(Excelente)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">üéØ M√©tricas de Retenci√≥n y Recomendaci√≥n</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">¬øRecomendar√≠an Siigo?</h6>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="flex-grow-1">
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-success" style="width: ${stats.would_recommend_percentage}%">
                                                        S√ç (${stats.would_recommend_percentage}%)
                                                    </div>
                                                    <div class="progress-bar bg-danger" style="width: ${100 - parseFloat(stats.would_recommend_percentage)}%">
                                                        NO (${(100 - parseFloat(stats.would_recommend_percentage)).toFixed(1)}%)
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">¬øRegresar√≠an a Siigo?</h6>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="flex-grow-1">
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-info" style="width: ${stats.would_return_percentage}%">
                                                        S√ç (${stats.would_return_percentage}%)
                                                    </div>
                                                    <div class="progress-bar bg-secondary" style="width: ${100 - parseFloat(stats.would_return_percentage)}%">
                                                        NO (${(100 - parseFloat(stats.would_return_percentage)).toFixed(1)}%)
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="alert ${parseFloat(stats.would_recommend_percentage) >= 60 ? 'alert-success' : parseFloat(stats.would_recommend_percentage) >= 40 ? 'alert-warning' : 'alert-danger'}" role="alert">
                                            <strong>An√°lisis de Retenci√≥n:</strong>
                                            ${parseFloat(stats.would_recommend_percentage) >= 60 
                                                ? '‚úÖ Excelente nivel de satisfacci√≥n. Los empleados recomiendan activamente trabajar en Siigo.' 
                                                : parseFloat(stats.would_recommend_percentage) >= 40 
                                                ? '‚ö†Ô∏è Nivel de satisfacci√≥n moderado. Hay oportunidades de mejora significativas.' 
                                                : 'üö® Nivel cr√≠tico de satisfacci√≥n. Se requiere acci√≥n inmediata para mejorar la experiencia del empleado.'
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const content = `
                <div class="analysis-content">
                    ${chartsHtml}
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">An√°lisis Estrat√©gico con IA</h5>
                            <small class="text-muted">Generado el ${new Date(data.timestamp).toLocaleString('es-ES')}</small>
                        </div>
                        <div class="card-body">
                            <div id="aiAnalysisContent">${analysis && analysis.trim() ? marked.parse(analysis) : '<div class="text-muted">No hay an√°lisis disponible</div>'}</div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button class="btn btn-success me-2" onclick="downloadAnalysis()">
                            <i class="bi bi-download"></i> Descargar Reporte
                        </button>
                        <button class="btn btn-outline-secondary" onclick="printAnalysis()">
                            <i class="bi bi-printer"></i> Imprimir
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('analysisModalBody').innerHTML = content;
            
            // Guardar datos para descarga
            window.currentAnalysis = data;
        }

        async function downloadAnalysis() {
            if (!window.currentAnalysis) {
                alert('No hay an√°lisis disponible para descargar');
                return;
            }
            
            const data = window.currentAnalysis;
            const timestamp = new Date().toISOString().split('T')[0];
            const stats = data.data.resumen_estadistico;
            const analysis = data.data.ai_analysis;
            
            // Mostrar mensaje de progreso
            const progressDiv = document.createElement('div');
            progressDiv.className = 'position-fixed top-50 start-50 translate-middle bg-white rounded-3 shadow-lg p-4 text-center';
            progressDiv.style.zIndex = '9999';
            progressDiv.innerHTML = `
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Generando PDF...</span>
                </div>
                <h5>Generando PDF...</h5>
                <p class="text-muted">Por favor espere mientras se genera el documento</p>
            `;
            document.body.appendChild(progressDiv);

            try {
                // Obtener el elemento del modal
                const modalBody = document.getElementById('analysisModalBody');
                
                if (!modalBody) {
                    throw new Error('No se encontr√≥ el contenido del an√°lisis');
                }

                // Usar html2canvas para capturar los gr√°ficos
                const canvas = await html2canvas(modalBody, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                });

                // Crear PDF con jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Configuraci√≥n del documento
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margins = 15;
                const contentWidth = pageWidth - (margins * 2);
                
                // T√≠tulo principal
                pdf.setFontSize(20);
                pdf.setTextColor(8, 172, 252); // Color Siigo
                pdf.text('AN√ÅLISIS GLOBAL DE ORGANIZACI√ìN', pageWidth / 2, 20, { align: 'center' });
                
                pdf.setFontSize(16);
                pdf.setTextColor(0, 0, 0);
                pdf.text('SIIGO - Sistema de Entrevistas de Retiro', pageWidth / 2, 30, { align: 'center' });
                
                // Informaci√≥n de fecha
                pdf.setFontSize(11);
                pdf.setTextColor(100, 100, 100);
                pdf.text(`Fecha de generaci√≥n: ${new Date().toLocaleString('es-ES')}`, margins, 45);
                pdf.text(`Respuestas analizadas: ${stats.total_responses}`, margins, 52);
                
                // L√≠nea separadora
                pdf.setDrawColor(8, 172, 252);
                pdf.setLineWidth(0.5);
                pdf.line(margins, 58, pageWidth - margins, 58);
                
                // Estad√≠sticas principales
                pdf.setFontSize(14);
                pdf.setTextColor(0, 0, 0);
                pdf.text('ESTAD√çSTICAS PRINCIPALES', margins, 68);
                
                pdf.setFontSize(11);
                const statsText = [
                    `‚Ä¢ Rating promedio de experiencia: ${stats.average_experience_rating}/10`,
                    `‚Ä¢ Porcentaje que recomendar√≠a la empresa: ${stats.would_recommend_percentage}%`,
                    `‚Ä¢ Porcentaje que regresar√≠a: ${stats.would_return_percentage}%`,
                    `‚Ä¢ Total de pa√≠ses representados: ${Object.keys(stats.countries_analysis || {}).length}`,
                    `‚Ä¢ Total de √°reas analizadas: ${Object.keys(stats.areas_analysis || {}).length}`
                ];
                
                let yPosition = 78;
                statsText.forEach(text => {
                    pdf.text(text, margins + 5, yPosition);
                    yPosition += 7;
                });
                
                // Agregar nueva p√°gina para los gr√°ficos
                pdf.addPage();
                
                // Agregar imagen de los gr√°ficos
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = contentWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const maxImgHeight = pageHeight - (margins * 2) - 20;
                
                if (imgHeight <= maxImgHeight) {
                    // Si cabe en una p√°gina
                    pdf.addImage(imgData, 'PNG', margins, 20, imgWidth, imgHeight);
                } else {
                    // Si necesita m√∫ltiples p√°ginas
                    let remainingHeight = imgHeight;
                    let sourceY = 0;
                    let currentPage = 2;
                    
                    while (remainingHeight > 0) {
                        const currentHeight = Math.min(remainingHeight, maxImgHeight);
                        const sourceHeight = (currentHeight * canvas.height) / imgHeight;
                        
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = canvas.width;
                        tempCanvas.height = sourceHeight;
                        
                        const ctx = tempCanvas.getContext('2d');
                        ctx.drawImage(canvas, 0, sourceY, canvas.width, sourceHeight, 0, 0, canvas.width, sourceHeight);
                        
                        const tempImgData = tempCanvas.toDataURL('image/png');
                        pdf.addImage(tempImgData, 'PNG', margins, 20, imgWidth, currentHeight);
                        
                        remainingHeight -= currentHeight;
                        sourceY += sourceHeight;
                        
                        if (remainingHeight > 0) {
                            pdf.addPage();
                            currentPage++;
                        }
                    }
                }
                
                // Agregar an√°lisis de IA si est√° disponible
                if (analysis) {
                    pdf.addPage();
                    pdf.setFontSize(14);
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('AN√ÅLISIS DE INTELIGENCIA ARTIFICIAL', pageWidth / 2, 20, { align: 'center' });
                    
                    // Convertir el an√°lisis markdown a texto plano
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = marked.parse(analysis);
                    const analysisText = tempDiv.textContent || tempDiv.innerText || '';
                    
                    // Dividir el texto en l√≠neas que quepan en el PDF
                    pdf.setFontSize(10);
                    const lines = pdf.splitTextToSize(analysisText, contentWidth);
                    
                    let y = 35;
                    const lineHeight = 5;
                    const maxY = pageHeight - margins;
                    
                    for (let i = 0; i < lines.length; i++) {
                        if (y + lineHeight > maxY) {
                            pdf.addPage();
                            y = 20;
                        }
                        pdf.text(lines[i], margins, y);
                        y += lineHeight;
                    }
                }
                
                // Footer en la √∫ltima p√°gina
                const totalPages = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setTextColor(150, 150, 150);
                    pdf.text(`P√°gina ${i} de ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    pdf.text('¬© Siigo - Sistema de Entrevistas de Retiro', pageWidth / 2, pageHeight - 5, { align: 'center' });
                }
                
                // Guardar el PDF
                pdf.save(`analisis_global_siigo_${timestamp}.pdf`);
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                alert('Error al generar el PDF. Por favor, intente nuevamente.');
            } finally {
                // Remover mensaje de progreso
                document.body.removeChild(progressDiv);
            }
        }

        function printAnalysis() {
            window.print();
        }

        // Actualizar datos cada 30 segundos
        setInterval(loadResponses, 30000);
    </script>
    



    </script>


</body>

</html>